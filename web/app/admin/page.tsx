'use client';

import { useEffect, useMemo, useState } from 'react';
import axios from 'axios';
import { DragDropContext, Droppable, Draggable, DropResult } from '@hello-pangea/dnd';

type Task = { id:number; slug:string; title:string; cadence:'weekly'|'biweekly' };
type Assignment = { id:number; planId:string; taskId:number; weekIndex:number; personId:number|null; autoGenerated:boolean };
type Person = { id:number; name:string; activeWeekly:boolean; activeBiweekly:boolean };
type AdminPlanResponse = {
  empty?: boolean;
  plan: { id:string; startsOn:string; weeks:number; status:string } | null;
  tasks: Task[];
  assignments: Assignment[];
  people: Person[];
};

export default function AdminPage() {
  const api = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:4000';

  const [loading, setLoading] = useState(true);
  const [empty, setEmpty] = useState(false);
  const [plan, setPlan] = useState<AdminPlanResponse['plan']>(null);
  const [tasks, setTasks] = useState<Task[]>([]);
  const [assignments, setAssignments] = useState<Assignment[]>([]);
  const [people, setPeople] = useState<Person[]>([]);
  const [busy, setBusy] = useState(false);

  async function load() {
    setLoading(true);
    try {
      const [r1, r2] = await Promise.all([
        axios.get<AdminPlanResponse>(`${api}/api/admin/plan`),
        axios.get<Person[]>(`${api}/api/people`),
      ]);
      const d = r1.data ?? {};
      setEmpty(!!d.empty || !d.plan);
      setPlan(d.plan ?? null);
      setTasks(d.tasks ?? []);
      setAssignments(d.assignments ?? []);
      setPeople(r2.data ?? []);
    } finally { setLoading(false); }
  }
  useEffect(() => { load(); }, []);

  async function generate() {
    setBusy(true);
    try { await axios.post(`${api}/api/plan/generate`); await load(); }
    finally { setBusy(false); }
  }
  async function publish() {
    if (!plan?.id) return;
    setBusy(true);
    try { await axios.post(`${api}/api/plan/${plan.id}/publish`); await load(); }
    finally { setBusy(false); }
  }

  function mondayLabel(week:number) {
    if (!plan?.startsOn) return '??.??';
    const start = new Date(plan.startsOn);
    start.setDate(start.getDate() + (week*7));
    return new Intl.DateTimeFormat('de-CH',{day:'2-digit',month:'2-digit'}).format(start);
  }
  function personName(id:number|null) {
    if (id==null) return '— frei —';
    return people.find(p=>p.id===id)?.name ?? '—';
  }

  // map: [taskId][week] -> assignment
  const cell = useMemo(() => {
    const map = new Map<number, Map<number, Assignment>>();
    for (const a of assignments) {
      const byTask = map.get(a.taskId) ?? new Map<number, Assignment>();
      byTask.set(a.weekIndex, a);
      map.set(a.taskId, byTask);
    }
    return (taskId:number, week:number) => map.get(taskId)?.get(week) || null;
  }, [assignments]);

  function onDragEnd(result: DropResult) {
    const { draggableId, source, destination } = result;
    if (!destination) return;

    const [destType, destIdStr] = destination.droppableId.split(':'); // "cell:<id>"
    if (destType !== 'cell') return;
    const destAssignId = Number(destIdStr);

    if (source.droppableId.startsWith('cell')) {
      // swap cell <-> cell
      const srcAssignId = Number(source.droppableId.split(':')[1]);
      if (srcAssignId === destAssignId) return;
      const src = assignments.find(a=>a.id===srcAssignId)!;
      const dst = assignments.find(a=>a.id===destAssignId)!;

      setAssignments(prev => prev.map(a => {
        if (a.id === srcAssignId)  return { ...a, personId: dst.personId };
        if (a.id === destAssignId) return { ...a, personId: src.personId };
        return a;
      }));
      axios.patch(`${api}/api/assignment/${srcAssignId}`,  { personId: dst.personId }).catch(load);
      axios.patch(`${api}/api/assignment/${destAssignId}`, { personId: src.personId }).catch(load);
    } else if (source.droppableId === 'people-weekly' || source.droppableId === 'people-biweekly') {
      // assign from either pool
      const personId = Number(draggableId.replace('person-', ''));
      setAssignments(prev => prev.map(a => a.id===destAssignId ? ({ ...a, personId }) : a));
      axios.patch(`${api}/api/assignment/${destAssignId}`, { personId }).catch(load);
    }
  }

  if (loading) return <main className="p-6">Lade…</main>;
  if (empty || !plan) {
    return (
      <main className="p-6">
        <button className="border rounded px-3 py-1" onClick={generate} disabled={busy}>
          {busy ? 'Erzeuge…' : 'Generate 16 Weeks'}
        </button>
      </main>
    );
  }

  const weeklyTasks   = tasks.filter(t=>t.cadence==='weekly');
  const biweeklyTasks = tasks.filter(t=>t.cadence==='biweekly');

  const weeklyPeople   = people.filter(p => p.activeWeekly);
  const biweeklyPeople = people.filter(p => p.activeBiweekly);

  return (
    <main className="p-6">
      <div className="mb-4 flex flex-wrap items-center gap-2">
        <button className="border rounded px-3 py-1" onClick={generate} disabled={busy}>
          {busy ? 'Erzeuge…' : 'Generate 16 Weeks'}
        </button>
        <button className="border rounded px-3 py-1" onClick={publish} disabled={busy || !plan?.id}>
          {busy ? 'Publiziere…' : 'Publish'}
        </button>
      </div>

      <DragDropContext onDragEnd={onDragEnd}>
        <div className="flex gap-4">
          {/* Sidebar with two pools */}
          <div className="w-64 space-y-4">
            <Droppable droppableId="people-weekly" isDropDisabled>
              {provided => (
                <div ref={provided.innerRef} {...provided.droppableProps} className="border rounded p-2 h-[32vh] overflow-auto">
                  <div className="font-medium mb-2">Weekly</div>
                  {weeklyPeople.map((p, idx)=>(
                    <Draggable draggableId={`person-${p.id}`} index={idx} key={`w-${p.id}`}>
                      {pProvided => (
                        <div ref={pProvided.innerRef} {...pProvided.draggableProps} {...pProvided.dragHandleProps}
                             className="border rounded px-2 py-1 mb-1 bg-white">
                          {p.name}
                        </div>
                      )}
                    </Draggable>
                  ))}
                  {provided.placeholder}
                </div>
              )}
            </Droppable>

            <Droppable droppableId="people-biweekly" isDropDisabled>
              {provided => (
                <div ref={provided.innerRef} {...provided.droppableProps} className="border rounded p-2 h-[32vh] overflow-auto">
                  <div className="font-medium mb-2">Bi-weekly</div>
                  {biweeklyPeople.map((p, idx)=>(
                    <Draggable draggableId={`person-${p.id}`} index={idx} key={`b-${p.id}`}>
                      {pProvided => (
                        <div ref={pProvided.innerRef} {...pProvided.draggableProps} {...pProvided.dragHandleProps}
                             className="border rounded px-2 py-1 mb-1 bg-white">
                          {p.name}
                        </div>
                      )}
                    </Draggable>
                  ))}
                  {provided.placeholder}
                </div>
              )}
            </Droppable>
          </div>

          {/* Grid */}
          <div className="overflow-auto">
            <table className="min-w-full border text-sm table-sticky">
              <thead>
                <tr>
                  <th className="cell-task">Task</th>
                  {Array.from({length:16}, (_,i)=>(
                    <th key={i} className="cell">{mondayLabel(i)}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {weeklyTasks.map(t=>(
                  <tr key={t.id}>
                    <td className="cell-task">{t.title}</td>
                    {Array.from({length:16}, (_,week)=>{
                      const a = cell(t.id, week);
                      const label = a ? personName(a.personId) : '—';
                      return (
                        <Droppable key={week} droppableId={`cell:${a?.id ?? -1}`}>
                          {provided => (
                            <td ref={provided.innerRef} {...provided.droppableProps}
                                className={`cell ${a?.personId==null ? 'cell-off' : ''}`}>
                              {a?.personId != null ? (
                                <Draggable draggableId={`assign-${a.id}`} index={0}>
                                  {p => (
                                    <div ref={p.innerRef} {...p.draggableProps} {...p.dragHandleProps}
                                         className="border rounded px-2 py-1 bg-white inline-block">
                                      {label}
                                    </div>
                                  )}
                                </Draggable>
                              ) : <span className="text-gray-500">{label}</span>}
                              {provided.placeholder}
                            </td>
                          )}
                        </Droppable>
                      );
                    })}
                  </tr>
                ))}

                <tr><td colSpan={17} className="separator" /></tr>

                {biweeklyTasks.map(t=>(
                  <tr key={t.id}>
                    <td className="cell-task">{t.title}</td>
                    {Array.from({length:16}, (_,week)=>{
                      const a = cell(t.id, week);
                      const label = a ? personName(a.personId) : '—';
                      return (
                        <Droppable key={week} droppableId={`cell:${a?.id ?? -1}`}>
                          {provided => (
                            <td ref={provided.innerRef} {...provided.droppableProps}
                                className={`cell cell-biweekly ${a?.personId==null ? 'cell-off' : ''}`}>
                              {a?.personId != null ? (
                                <Draggable draggableId={`assign-${a.id}`} index={0}>
                                  {p => (
                                    <div ref={p.innerRef} {...p.draggableProps} {...p.dragHandleProps}
                                         className="border rounded px-2 py-1 bg-white inline-block">
                                      {label}
                                    </div>
                                  )}
                                </Draggable>
                              ) : <span className="text-gray-500">{label}</span>}
                              {provided.placeholder}
                            </td>
                          )}
                        </Droppable>
                      );
                    })}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </DragDropContext>
    </main>
  );
}
